<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Henry's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="前言这篇文章是自己对于学习iOS底层的 RunLoop 的一个整理和记录，主要参考了 Apple 的官方文档和网上大神们的文章，然后加以自己的理解和验证完成的。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS之初识RunLoop">
<meta property="og:url" content="http://yoursite.com/2016/08/26/iOS之初识RunLoop/index.html">
<meta property="og:site_name" content="Henry's blog">
<meta property="og:description" content="前言这篇文章是自己对于学习iOS底层的 RunLoop 的一个整理和记录，主要参考了 Apple 的官方文档和网上大神们的文章，然后加以自己的理解和验证完成的。">
<meta property="og:image" content="http://ocgehzzvy.bkt.clouddn.com/appLiftCycle.jpg">
<meta property="og:image" content="http://ocgehzzvy.bkt.clouddn.com/runLoop%E5%90%AF%E5%8A%A8.png">
<meta property="og:image" content="http://ocgehzzvy.bkt.clouddn.com/runloopWorkflow.jpg">
<meta property="og:image" content="http://ocgehzzvy.bkt.clouddn.com/runLoopLogic.png">
<meta property="og:updated_time" content="2016-11-23T09:58:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS之初识RunLoop">
<meta name="twitter:description" content="前言这篇文章是自己对于学习iOS底层的 RunLoop 的一个整理和记录，主要参考了 Apple 的官方文档和网上大神们的文章，然后加以自己的理解和验证完成的。">
<meta name="twitter:image" content="http://ocgehzzvy.bkt.clouddn.com/appLiftCycle.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/08/26/iOS之初识RunLoop/"/>

  <title> iOS之初识RunLoop | Henry's blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Henry's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Stay Hungry, Stay Foolish</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS之初识RunLoop
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-26T15:18:11+08:00" content="2016-08-26">
              2016-08-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章是自己对于学习iOS底层的 RunLoop 的一个整理和记录，主要参考了 Apple 的官方文档和网上大神们的文章，然后加以自己的理解和验证完成的。</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><a id="more"></a></h2><h2 id="什么是-RunLoop？"><a href="#什么是-RunLoop？" class="headerlink" title="什么是 RunLoop？"></a>什么是 RunLoop？</h2><p>先来看看Apple文档对RunLoop的定义：</p>
<blockquote>
<p>Run loops are part of the fundamental infrastructur associated with threads. A run loop is an event processing loop that you use to schedule work and coordinate the recipt of incoming events. The purpose of run loop is to keep your thread busy when there is work to do and put your thread to sleep when there is none. </p>
<p>Run loop management is not entirely automatic. You must sitll design your thread’s code to start the run loop appropriate times and respond to incoming events. Both Cocoa and Core Foundation provide <em>run loop objects</em> to help you configure and manage your thread’s run loop. Your application does not need to create these objects explicitly; each thread, including the application’s main thread, has an associated run loop object. Only secondry threads need to run loop explicitly, however. The app frameworks automatically set up and run the run loop on the main thread as part of the application startup process.</p>
</blockquote>
<p>按照文档的字面意思大致可以理解为：</p>
<p>RunLoop 是和线程相关的基础架构的一部分，所以和线程的关系应该很紧密。我们可以把 RunLoop 拆L成 Run 和 Loop 两部分来理解，先来看 Loop 的意思：Loop 就是一个循环的过程，这个循环过程是用来处理事件的。再来看 Run 的意思：就是跑起来，不要停，驱使 Loop 在线程中一直跑着。合起来看 RunLoop 就是一个循环处理事件的过程。在这个过程中 RunLoop 要确保线程在有活要干的时候立马能起来干活，没活干的时候赶紧睡觉，不要浪费宝贵的资源。</p>
<p>RunLoop的管理不是完全自动的，需要我们在设计线程代码的时候在适当的时候去启动它正确的响应输入事件。CocoaL和 Core Foundation 为我们提供了run loop objects来帮助我们配置和管理我们线程中的 RunLoop。每一个线程，包括主线程，都有一个与之相关联的 RunLoop。在程序中，作为应用启动的一部分，主线程会自动的设置和启动它的 RunLoop，而其它的辅助线程则需要我们显示的启动运行RunLoop。</p>
<hr>
<h2 id="App的启动过程"><a href="#App的启动过程" class="headerlink" title="App的启动过程"></a>App的启动过程</h2><p>我们先来看一下App启动过程中的main函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char *argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为什么main函数执行结束后，程序没有退出呢？而是能够继续维持运行呢？<br>这背后的原因就是run loop在起作用。因为主线程中的run loop是作为程序启动的一部分而自动运行的，所以我们的程序不会退出，而是一直在等待事件到来，处理事件，再等待的循环中运行着，直到程序的退出。</p>
<p>可以借用下面的图来加深理解：</p>
<p><img src="http://ocgehzzvy.bkt.clouddn.com/appLiftCycle.jpg" alt="此处输入图片的描述"></p>
<p>通过在程序中加断点我们可以清楚的发现主线程中run loop的启动过程：</p>
<p><img src="http://ocgehzzvy.bkt.clouddn.com/runLoop%E5%90%AF%E5%8A%A8.png" alt="此处输入图片的描述"></p>
<hr>
<h2 id="Run-loop-Run-loop-object和线程的关系？"><a href="#Run-loop-Run-loop-object和线程的关系？" class="headerlink" title="Run loop/Run loop object和线程的关系？"></a>Run loop/Run loop object和线程的关系？</h2><p>简单的来说，线程就是在系统中用来执行任务的最小单位。通常一个线程一次只能执行一个任务，而且执行任务的控制流是顺序的，当任务执行完成后，线程也会随之结束退出。</p>
<p>Run loop的作用就是能够保证线程在任务执行完成后，紧接着不会随着退出。而是继续运行着，等待响应新事件的到来。</p>
<p>从Apple文档中可以看出，run loop 其实是一个对象，是寄生于线程中的，和线程具有一一对应的关系。在Mac OS/iOS系统中，线程中已经存在了与之对应的run loop object，我们再不需要为线程显示的创建一个run loop object。Apple也不允许我们自己为线程创建run loop object，在<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/NSRunLoop_Class/index.html#//apple_ref/occ/cl/NSRunLoop" target="_blank" rel="external">NSRunLoop</a>和<a href="https://developer.apple.com/library/mac/documentation/CoreFoundation/Reference/CFRunLoopRef/index.html#//apple_ref/doc/uid/20001441" target="_blank" rel="external">CFRunLoop</a>的文档中只有获取线程内run loop object的方法，而没有新建run loop object的方法。</p>
<p>系统为我们提供了两个run loop对象：</p>
<ul>
<li>NSRunLoop:是对CFRunLoopRef的面向对象的封装，是<strong>线程不安全</strong>的 </li>
<li>CFRunLoopRef:是在CoreFoundation框架内，是纯C函数的API，是<strong>线程安全</strong>的</li>
</ul>
<p>CFRunLoopRef为我们提供了两个方法来获取线程中的run loop对象，<strong>CFRunLoopGetMain()</strong>    和<strong>CFRunLoopGetCurrent()</strong>,我们可以查看CFRunLoop的<a href="http://opensource.apple.com/source/CF/CF-855.17/CFRunLoop.c" target="_blank" rel="external">开源代码</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">/*全局量dict，用来记录线程对应的run loop 对象，&lt;key: value&gt;对应&lt;线程pthread的指针: CFRunLoop对象&gt;*/</div><div class="line">static CFMutableDictionaryRef __CFRunLoops = NULL;  </div><div class="line">static CFSpinLock_t loopsLock = CFSpinLockInit;     /*访问全局量时用到的锁*/</div><div class="line"></div><div class="line">CFRunLoopRef _CFRunLoopGet0(pthread_t t) &#123;</div><div class="line">    </div><div class="line">    __CFSpinLock(&amp;loopsLock);</div><div class="line">    </div><div class="line">    /*1. 第一次启动时，系统中没有run loop对象，全局量dict不存在，需要初始化全局量 */</div><div class="line">    if (!__CFRunLoops) &#123;</div><div class="line">        __CFSpinUnlock(&amp;loopsLock);</div><div class="line">        </div><div class="line">	    CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line">	    </div><div class="line">	    // 首先是为主线程创建一个run loop对象</div><div class="line">	    CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</div><div class="line">	    CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</div><div class="line">	    </div><div class="line">	    if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) &#123;</div><div class="line">	        CFRelease(dict);</div><div class="line">	    &#125;</div><div class="line">	    </div><div class="line">	    CFRelease(mainLoop);</div><div class="line">        __CFSpinLock(&amp;loopsLock);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    /* 2. 如果程序中已经存在一个记录run loop对象的全局量dict，试图获取线程对应的run loop对象 */</div><div class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">    __CFSpinUnlock(&amp;loopsLock);</div><div class="line">    </div><div class="line">    /*3. 线程对应的run loop对象获取失败，则为这个线程新建一个run loop对象 */</div><div class="line">    if (!loop) &#123;</div><div class="line">	    CFRunLoopRef newLoop = __CFRunLoopCreate(t);</div><div class="line">        __CFSpinLock(&amp;loopsLock);</div><div class="line">	    loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">	    </div><div class="line">	    if (!loop) &#123;</div><div class="line">	        /* 更新全局量中的记录*/</div><div class="line">	        CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</div><div class="line">	        loop = newLoop;</div><div class="line">	    &#125;</div><div class="line">        __CFSpinUnlock(&amp;loopsLock);</div><div class="line">	    CFRelease(newLoop);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //注册回调RunLoop结束时的回调函数</div><div class="line">    if (pthread_equal(t, pthread_self())) &#123;</div><div class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL);</div><div class="line">        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</div><div class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*获取主线程run loop的方法*/</div><div class="line">CFRunLoopRef CFRunLoopGetMain(void) &#123;</div><div class="line">    static CFRunLoopRef __main = NULL; </div><div class="line">    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); </div><div class="line">    return __main;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*获取当前线程run loop的方法*/</div><div class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</div><div class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</div><div class="line">    if (rl) return rl;</div><div class="line">    return _CFRunLoopGet0(pthread_self());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码中，我们可以发现线程和run loop对象是一一对应的，记录在一个全局的dictionary里。创建线程的时候，并不会自动生成相应的run loop对象，只有主动获取run loop对象的时候才会创建相应的run loop对象。主线程是个特例，它在创建的时候就自动生成了相应的run loop对象。</p>
<hr>
<h2 id="Run-Loop解析"><a href="#Run-Loop解析" class="headerlink" title="Run Loop解析"></a>Run Loop解析</h2><p>Run loop本身听起来和它的名字很像，它是一个循环，允许你的线程进入和用它来运行响应接收事件的处理程序。我们的代码要提供实现循环部分的控制语句，比如使用while或for来驱动RunLoop。在循环中，我们使用<em>run loop object</em>来运行事件的处理程序，它响应接收事件并运行处理程序。</p>
<p>我们可以先看一下，Apple给我们画的run loop的模型图：</p>
<p><img src="http://ocgehzzvy.bkt.clouddn.com/runloopWorkflow.jpg" alt="此处输入图片的描述"></p>
<p>Run Loop从两个不同的事件源中接收消息：</p>
<ul>
<li><code>Input sources</code>：异步传递的事件，通常来自其它线程或其它的应用。</li>
<li><code>Timer sources</code>：同步传递的事件，在特定时间发生的事件或者重复发生的事件。</li>
</ul>
<p>除了处理输入源，run loops也会生成关于run loop行为的通知(notifications)。注册的run loop观察者(run-loop Observers)可以收到这些通知，并在线程上面使用它们来做额外的处理。</p>
<p>RunLoop中最关键的是要理解其中的<strong>RunLoop Mode</strong>。</p>
<h3 id="Run-Loop-Mode"><a href="#Run-Loop-Mode" class="headerlink" title="Run Loop Mode"></a>Run Loop Mode</h3><p>Apple文档定义：</p>
<blockquote>
<p>A run loop mode is a collection of input sources and timers to be monitored and a collection of run loop observers to be notified.</p>
</blockquote>
<p>字面理解，run loop mode就是：包含了一组需要监控对象（input source和timer）和一组需要通知的对象（loop observer）的集合。</p>
<p>每次运行你的run loop，你都要指定（无论显示还是隐式）其运行的模式。在run loop运行过程中，只有和模式相关的源才会被监视并允许他们传递事件消息。（类似的，只有和模式相关的观察者会通知run loop的进程）。和其他模式关联的源只有在run loop运行在其模式下才会运行，否则处于暂停状态。</p>
<p>一个 RunLoop 可以包含若干个 RunLoop Mode，每个 Mode 又包含若干个 Source/Timer/Observer。每次调用 RunLoop 的主函数时，只能指定run loop运行在其中一个 Mode 上，这个Mode被称作 CurrentMode。如果需要切换 Mode，只能退出当前运行的Run Loop，再重新指定一个 Mode 重新进入。这样做主要是为了分隔开不同组的 Source/Timer/Observer，让其互不影响。</p>
<p>在代码中，我们可以通过指定名字来标识模式。Cocoa和Core foundation定义了一个默认的和一些常用的模式，使用字符串来标识这些模式。我们也可以给模式名称指定一个字符串来自定义模式。虽然你可以给模式指定任意名字，但是模式的内容则不能是任意的。你必须添加一个或多个输入源，定时源或者run loop的观察者到你新建的模式中让他们起作用。</p>
<p>以下是系统中已经定义的Mode：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NSDefaultRunLoopMode: 大多数工作中默认的运行方式。</div><div class="line">NSConnectionReplyMode: 使用这个Mode去监听NSConnection对象的状态，我们很少需要自己使用这个Mode。</div><div class="line">NSModalPanelRunLoopMode: 使用这个Mode在Model Panel情况下去区分事件(OS X开发中会遇到)。</div><div class="line">UITrackingRunLoopMode: 使用这个Mode去跟踪来自用户交互的事件（比如UITableView上下滑动）。</div><div class="line">GSEventReceiveRunLoopMode: 用来接受系统事件，内部的Run Loop Mode。</div><div class="line">NSRunLoopCommonModes: 这是一个伪模式，其为一组run loop mode的集合。如果将Input source加入此模式，意味着关联Input source到Common Modes中包含的所有模式下。在iOS系统中NSRunLoopCommonMode包含NSDefaultRunLoopMode、NSTaskDeathCheckMode、UITrackingRunLoopMode.可使用CFRunLoopAddCommonMode方法向Common Modes中添加自定义mode。</div></pre></td></tr></table></figure></p>
<p>值得需要记住的几个地方：</p>
<ul>
<li>Run Loop运行时只能以一种固定的Mode运行，只会监控这个Mode下添加的Timer source和Input source。如果这个Mode下没有添加事件源，Run Loop会立刻返回。</li>
<li>Run Loop不能在运行在NSRunLoopCommonModes，因为NSRunLoopCommonModes是个Mode集合，而不是一个具体的Mode。我们可以在添加事件源的时候使用NSRunLoopCommonModes，只要Run Loop运行在NSRunLoopCommonModes中任何一个Mode，这个事件源都可以被触发。</li>
</ul>
<hr>
<h3 id="RunLoop的输入源"><a href="#RunLoop的输入源" class="headerlink" title="RunLoop的输入源"></a>RunLoop的输入源</h3><p>Input source有两个不同的种类: Port-Based Sources 和 Custom Input Sources。Run Loop本身并不关心Input source是哪一种类型。系统会实现两种不同的Input source供我们使用。这两种不同类型的Input source的区别在于：Port-Based Sources由内核自动发送，Custom Input Sources需要从其他线程手动发送。</p>
<p>当我们创建输入源后，需要将其分配给run loop中的一个或多个模式。模式只会在只会响应处理添加到自身模式下的事件源，而会忽略添加到其它模式下面的源。大多数情况下，run loop运行在默认模式下，但是你也可以使其运行在自定义模式或者其它指定的模式下。若某一源在当前模式下不被监听，那么任何其生成的消息只在run loop运行在其关联的模式下才会被传递。</p>
<h5 id="基于端口的输入源"><a href="#基于端口的输入源" class="headerlink" title="基于端口的输入源"></a>基于端口的输入源</h5><p>通过内置的端口相关的对象和函数，配置基于端口的Input source。 (比如在主线程创建子线程时传入一个NSPort对象,主线程和子线程就可以进行通讯。NSPort对象会负责自己创建和配置Input source。)</p>
<h5 id="自定义的输入源"><a href="#自定义的输入源" class="headerlink" title="自定义的输入源"></a>自定义的输入源</h5><p>为了创建自定义输入源，必须使用Core Foundation里面的CFRunLoopSourceRef类型相关的函数来创建。可以使用回调函数来配置自定义输入源。Core Fundation会在配置源的不同地方调用回调函数，处理输入事件，当从run loop移除的时候清理它。</p>
<h5 id="Cocoa-Perform-Selector-Sources"><a href="#Cocoa-Perform-Selector-Sources" class="headerlink" title="Cocoa Perform Selector Sources"></a>Cocoa Perform Selector Sources</h5><p>除了基于端口的源，Cocoa也为我们提供了自定义的输入源，允许我们在任何线程执行selector。和基于端口的源一样，执行selector请求会在目标线程上序列化，减缓许多在线程上允许多个方法容易引起的同步问题。不像基于端口的源，一个selector执行完后会自动从run loop里面移除。</p>
<hr>
<h3 id="RunLoopTimer（定时源）"><a href="#RunLoopTimer（定时源）" class="headerlink" title="RunLoopTimer（定时源）"></a>RunLoopTimer（定时源）</h3><p>Timer source在预设的时间点同步的传递消息。Timer是线程通知自己做某件事的一种方式。</p>
<p>Foundation中 NSTimer Class提供了相关方法来设置Timer source。需要注意的是除了scheduledTimerWithTimeInterval开头的方法创建的Timer都需要手动添加到当前Run Loop中。（scheduledTimerWithTimeInterval 创建的timer会自动以Default Mode加载到当前Run Loop中。）</p>
<p><strong>Timer在选择使用一次后，在执行完成时，会从Run Loop中移除。选择循环时，会一直保存在当前Run Loop中，直到调用invalidated方法。</strong></p>
<hr>
<h3 id="RunLoopObserver"><a href="#RunLoopObserver" class="headerlink" title="RunLoopObserver"></a>RunLoopObserver</h3><p>事件源是同步或者异步的事件驱动时触发，而Run Loop Observer则在Run Loop本身进入某个状态时得到通知:</p>
<blockquote>
<p>Run Loop 进入的时候<br>Run Loop 处理一个Timer的时候<br>Run Loop 处理一个Input Source的时候<br>Run Loop 进入睡眠的时候<br>Run Loop 被唤醒的时候，在唤醒它的事件被处理之前<br>Run Loop 停止的时候</p>
</blockquote>
<p><strong>和定时器类似，run loop观察者可以只用一次或循环使用。若只用一次，那么在它启动后，会把它自己从run loop里面移除，而循环的观察者则不会。你在创建run loop观察者的时候需要指定它是运行一次还是多次。</strong></p>
<hr>
<h3 id="Run-Loop内部实现"><a href="#Run-Loop内部实现" class="headerlink" title="Run Loop内部实现"></a>Run Loop内部实现</h3><p>CFRunLoop中主要使用<em>CFRunLoopRun</em>和<em>CFRunLoopRunSpecific</em>函数来启动run loop过程。而<em>CFRunLoopRun</em>和<em>CFRunLoopRunSpecific</em>函数内部都调用了<em>CFRunLoopRunSepcific</em>函数，<em>CFRunLoopRunSepcific</em>函数内部调用了<em>__CFRunLoopRun</em>函数。</p>
<p>我们也可以查看一下CFRunLoop的<a href="http://opensource.apple.com/source/CF/CF-855.17/CFRunLoop.c" target="_blank" rel="external">开源代码</a>，能够发现大概如下的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div></pre></td><td class="code"><pre><div class="line">/*用defaultMode，启动线程的run loop*/</div><div class="line">void CFRunLoopRun(void) &#123;	/* DOES CALLOUT */</div><div class="line">    int32_t result;</div><div class="line">    do &#123;</div><div class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);</div><div class="line">        /* 循环检查 */</div><div class="line">    &#125; while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*用指定的Mode，开启线程的run loop，可以指定run loop超时结束的时间*/</div><div class="line">SInt32 CFRunLoopRunInMode(CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) &#123;     /* DOES CALLOUT */</div><div class="line">    return CFRunLoopRunSpecific(CFRunLoopGetCurrent(), modeName, seconds, returnAfterSourceHandled);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*run loop的执行方式*/</div><div class="line">SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) &#123;     /* DOES CALLOUT */</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return kCFRunLoopRunFinished;</div><div class="line">    </div><div class="line">    /*根据modeName查找 run loop mode*/</div><div class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false); </div><div class="line">    </div><div class="line">    /* run loop mode不存在，返回run loop结束状态kCFRunLoopRunFinished*/</div><div class="line">    if (NULL == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</div><div class="line">	    return kCFRunLoopRunFinished;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    /* 记录run loop原有的mode为previousMode，更新run loop中的mode为新查找到的currentMode*/</div><div class="line">    volatile _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</div><div class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</div><div class="line">    rl-&gt;_currentMode = currentMode;</div><div class="line">    </div><div class="line">    /* 初始化run loop的状态*/</div><div class="line">    int32_t result = kCFRunLoopRunFinished;</div><div class="line"></div><div class="line">    /* 通知observer， run loop开始启动，状态是kCFRunLoopEntry*/</div><div class="line">	if (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</div><div class="line">	</div><div class="line">	/*run loop的具体实现， 调用内部函数__CFRunLoopRun*/</div><div class="line">	result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</div><div class="line">	</div><div class="line">	/* 通知observer， run loop结束了，状态是kCFRunLoopExit*/</div><div class="line">	if (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</div><div class="line"></div><div class="line">    /* 读取当前的run loop mode数据， 并设置为previousMode， 为下一次run loop使用*/    </div><div class="line">    __CFRunLoopPopPerRunData(rl, previousPerRun);</div><div class="line">	rl-&gt;_currentMode = previousMode;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* 内部函数__CFRunLoopRun的实现方式，这个才是run loop执行的真正实现的地方</div><div class="line">** 去掉了关于对象锁机制的读写操作和一些不影响理解的代码段</div><div class="line">*/</div><div class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</div><div class="line">    ...</div><div class="line">    /* 此处省略了一大段关于判断队列安全性和timeout的代码*/</div><div class="line"></div><div class="line">    Boolean didDispatchPortLastTime = true;</div><div class="line">    int32_t retVal = 0;</div><div class="line">    do &#123;</div><div class="line">        uint8_t msg_buffer[3 * 1024];</div><div class="line"></div><div class="line">        mach_msg_header_t *msg = NULL;</div><div class="line">        mach_port_t livePort = MACH_PORT_NULL;</div><div class="line"></div><div class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</div><div class="line"></div><div class="line">        /*通知observer， run loop即将触发timer的回调*/</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</div><div class="line">        /*通知observer， run loop即将触发source0的回调*/</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</div><div class="line"></div><div class="line">        //执行需要完成的block代码</div><div class="line">	    __CFRunLoopDoBlocks(rl, rlm);</div><div class="line"></div><div class="line">        //run loop触发了source0的回调，处理source0的任务</div><div class="line">        /*__CFRunLoopDoSources0 函数调用了内部函数__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__来处理接受的事件，通过之前的断点堆栈可以验证这个过程*/</div><div class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</div><div class="line">        if (sourceHandledThisLoop) &#123;</div><div class="line">            __CFRunLoopDoBlocks(rl, rlm);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR);</div><div class="line"></div><div class="line">        /*检查是否接受到了来自系统的mach ports的事件*/</div><div class="line">        if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            //如果有需要处理source1的消息，则直接开始处理这个消息</div><div class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0)) &#123;</div><div class="line">                goto handle_msg; //跳转到消息处理代码模块</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        didDispatchPortLastTime = false;</div><div class="line"></div><div class="line">    /*通知observer，run loop即将进入休眠状态*/</div><div class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) </div><div class="line">	    __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</div><div class="line">	    </div><div class="line">	 //设置run loop休眠   </div><div class="line">	__CFRunLoopSetSleeping(rl);</div><div class="line">        </div><div class="line">    /* 到这个时候我们的run loop已经进入了休眠的状态，如果没有事件去唤醒它，run loop将一直处于sleep的状态或者说处于等待被唤醒的状态。</div><div class="line">    *  能够唤醒run loop的事件：</div><div class="line">    *  - 基于mach ports的source1事件</div><div class="line">    *  - timer时间到了</div><div class="line">    *  - runloop的超时时间到了（run loop超时就退出了）</div><div class="line">    *  - 其他的手动唤醒事件</div><div class="line">    */</div><div class="line">        msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY);</div><div class="line">        </div><div class="line">    //run loop 被唤醒了，又满血复活，通知Observer，我胡汉三又回来了</div><div class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) </div><div class="line">	    __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</div><div class="line"></div><div class="line">        handle_msg:; // 处理接收的消息</div><div class="line"></div><div class="line">        if (MACH_PORT_NULL == livePort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</div><div class="line">            // handle nothing</div><div class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</div><div class="line">            // do nothing on Mac OS</div><div class="line">        &#125;</div><div class="line">        else if (livePort == dispatchPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</div><div class="line"></div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);</div><div class="line">            </div><div class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</div><div class="line"></div><div class="line"> 	        sourceHandledThisLoop = true;</div><div class="line">            didDispatchPortLastTime = true;</div><div class="line">        &#125; else &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</div><div class="line">            </div><div class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</div><div class="line">            if (rls) &#123;</div><div class="line">                /*处理source1的事件*/</div><div class="line">		        sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</div><div class="line">		    if (NULL != reply) &#123;</div><div class="line">		        (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</div><div class="line">		    &#125;</div><div class="line">	    &#125;</div><div class="line">    &#125; </div><div class="line">        </div><div class="line">     //执行需要完成的block代码 </div><div class="line">	__CFRunLoopDoBlocks(rl, rlm);</div><div class="line">       </div><div class="line">    //检查事件处理结束后的状态，如果结果是0，则继续run loop，否则退出。</div><div class="line">	if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</div><div class="line">	    retVal = kCFRunLoopRunHandledSource;</div><div class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</div><div class="line">            retVal = kCFRunLoopRunTimedOut;</div><div class="line">	&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</div><div class="line">            __CFRunLoopUnsetStopped(rl);</div><div class="line">	    retVal = kCFRunLoopRunStopped;</div><div class="line">	&#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">	    rlm-&gt;_stopped = false;</div><div class="line">	    retVal = kCFRunLoopRunStopped;</div><div class="line">	&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</div><div class="line">	    retVal = kCFRunLoopRunFinished;</div><div class="line">	&#125;</div><div class="line">    &#125; while (0 == retVal);</div><div class="line"></div><div class="line">    return retVal;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们不难发现，实际上 RunLoop 就是这样一个函数，其内部是一个 do-while 循环。当你调用 CFRunLoopRun() 时，线程就会一直停留在这个循环里；直到超时或被手动停止，该函数才会返回。</p>
<p>整个执行的流程可以借用下面的图帮助理解：</p>
<p><img src="http://ocgehzzvy.bkt.clouddn.com/runLoopLogic.png" alt="此处输入图片的描述"></p>
<hr>
<h2 id="我们什么时候需要用到run-loop"><a href="#我们什么时候需要用到run-loop" class="headerlink" title="我们什么时候需要用到run loop"></a>我们什么时候需要用到run loop</h2><p>通过阅读Apple的<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW24" target="_blank" rel="external">文档</a>我们可以发现，只有当程序中创建了新的子线程的时候才可能需要启动run loop。程序中的main thread中的run loop是在程序运行启动的时候，已经默认自动的启动好了，不需要显示的加以启动。 </p>
<p>对于我们自己新创建的子线程来说，如果需要启动run loop，则必须对run loop进行必要的配置和加以显示的启动。因为子线程中的run loop是不会自动运行的。子线程不需要对所有的情况都使用run loop来处理事件，比如对于一些需要长时间处理的任务和已经预设好的任务则不用run loop。</p>
<p>而对于一些和线程交互密切的任务则可以使用run loop来处理：</p>
<ul>
<li>使用ports和自定义的输入源来进行进程间的通信</li>
<li>线程中使用timer</li>
<li>线程中使用performSelector…函数簇  </li>
<li>线程需要处理周期性的任务</li>
</ul>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本人能力有限，可能很多地方讲的不是很清楚，甚至有些地方不对。<br>文章中的大部分概念性的东西都是参考了Apple的官方文档加以自己的理解写出来的，同时也参考了CFRunLoop的开源代码。<br>在这里只是提到了一些RunLoop的概念性东西，对于它的作用和在实际应用中的使用没有提及。<br>我会继续深入的研究这部分的内容，并完成一些Demo。</p>
<hr>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW24" target="_blank" rel="external">Apple文档</a></li>
<li><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">深入理解RunLoop</a>，by ibireme</li>
<li>sunnyxx关于RunLoop的线下分享视频</li>
</ol>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/09/20/iOS隐藏键盘/" rel="prev" title="iOS隐藏键盘">
                iOS隐藏键盘 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Henry" />
          <p class="site-author-name" itemprop="name">Henry</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number">2.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是-RunLoop？"><span class="nav-number">3.</span> <span class="nav-text">什么是 RunLoop？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#App的启动过程"><span class="nav-number">4.</span> <span class="nav-text">App的启动过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-loop-Run-loop-object和线程的关系？"><span class="nav-number">5.</span> <span class="nav-text">Run loop/Run loop object和线程的关系？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Run-Loop解析"><span class="nav-number">6.</span> <span class="nav-text">Run Loop解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Run-Loop-Mode"><span class="nav-number">6.1.</span> <span class="nav-text">Run Loop Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoop的输入源"><span class="nav-number">6.2.</span> <span class="nav-text">RunLoop的输入源</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基于端口的输入源"><span class="nav-number">6.2.0.1.</span> <span class="nav-text">基于端口的输入源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自定义的输入源"><span class="nav-number">6.2.0.2.</span> <span class="nav-text">自定义的输入源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Cocoa-Perform-Selector-Sources"><span class="nav-number">6.2.0.3.</span> <span class="nav-text">Cocoa Perform Selector Sources</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopTimer（定时源）"><span class="nav-number">6.3.</span> <span class="nav-text">RunLoopTimer（定时源）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RunLoopObserver"><span class="nav-number">6.4.</span> <span class="nav-text">RunLoopObserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Run-Loop内部实现"><span class="nav-number">6.5.</span> <span class="nav-text">Run Loop内部实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#我们什么时候需要用到run-loop"><span class="nav-number">7.</span> <span class="nav-text">我们什么时候需要用到run loop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Henry</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  

  

  

</body>
</html>
